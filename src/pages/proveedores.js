import { useEffect, useState } from 'react'
import Head from 'next/head'
import Link from 'next/link'
import { useRouter } from 'next/router'

// terceros
import SwiperCore, { Navigation } from 'swiper'
import { Swiper, SwiperSlide } from 'swiper/react'

// components
import Slogan from '@/components/Slogan'

// utils
import Store from '@/svg/Store'
import useParams from '@/hooks/useParams'
import ChevronRight from '@/svg/ChevronRight'
import { useBreakPoint } from '@/hooks/useBreakPoint'

import { useGetBusquedaAvanzadaQuery } from '../generated/graphql'

// styles
import styles from '@/styles/components/proveedores/proveedores.module.scss'
import Empty from '../components/Empty'

SwiperCore.use([Navigation])

// const initialData = {
//   GetBusquedaAvanzada: {
//     data: [],
//     nroTotalItems: 0
//   }
// }

const Proveedores = () => {
  const router = useRouter()
  const [cats, setCats] = useState([])
  const [nroCategorias, setNroCategorias] = useState(5)
  const { nroSlides } = useBreakPoint({ xs: 2, sm: 2, md: 2, lg: 3, xl: 5 })
  const { params } = useParams({
    motor: '',
    marca: '',
    modelo: ''
  })

  const [variables, setVariables] = useState({
    page: 1,
    numberPaginate: nroCategorias,
    volkswagen: null,
    mercedes: null,
    c17210od: null,
    of1722: null,
    of1721: null,
    cummins: null,
    om366: null,
    om906: null,
    om924: null,
    categoriaId: null
  })

  useGetBusquedaAvanzadaQuery({
    variables,
    onCompleted: (data) => {
      if (data) {
        const { GetBusquedaAvanzada, GetAllCategorias } = data
        const categorias = [...GetAllCategorias].reduce((prev, cat) => {
          const tienda = GetBusquedaAvanzada.data.filter(({ Categorias }) => {
            return Categorias.some(({ categoriaId }) => {
              return categoriaId === cat.categoriaId
            })
          })

          if (tienda.length === 0) {
            return [...prev]
          } else {
            return [...prev, { ...cat, tienda }]
          }
        }, [])

        // console.log('RESULT', categorias)
        setCats(categorias)
      }
    }
  })

  useEffect(() => {
    setVariables({
      page: 1,
      numberPaginate: nroCategorias,
      volkswagen: params.marca === 'Volkswagen' ? 1 : null,
      mercedes: params.marca === 'Mercedes Benz' ? 1 : null,
      c17210od: params.modelo === '17-210 OD' ? 1 : null,
      of1722: params.modelo === 'OF 1722' ? 1 : null,
      of1721: params.modelo === 'OF 1721' ? 1 : null,
      cummins: params.motor === 'Cummins Serie B-GAS' ? 1 : null,
      om366: params.motor === 'OM 366 LA' ? 1 : null,
      om906: params.motor === 'OM 906' ? 1 : null,
      om924: params.motor === 'OM 924 LA' ? 1 : null,
      categoriaId: null
    })
  }, [params])

  const handleDetailStore = (tienda) => {
    router.push({
      pathname: '/detalle-tienda',
      query: {
        ...params,
        tienda
      }
    })
  }

  const handleMore = () => setNroCategorias((c) => c + 1)

  const brandLogo = (brand) => {
    if (brand === 'Volkswagen') return '/images/volkswagen.jpg'
    if (brand === 'Mercedes Benz') return '/images/mercedes.png'
  }

  const renderMoreButton = () => {
    return (
      <div onClick={handleMore} className={styles.proveedores_mostrar}>
        <button className="btn btn-primary">Mostrar mas</button>
      </div>
    )
  }

  return (
    <div>
      <Head>
        <title>Cotizaya | Proveedores</title>
        <link rel="icon" href="/favicon.ico" />
        <meta name="description" content="Generated by create next app" />
      </Head>

      <Slogan />

      <div className={styles.proveedores}>
        <h3 className={styles.proveedores_slogan}>
          AQUÍ ESTÁN TODAS LAS TIENDAS DE REPUESTOS PARA EL {params.marca}{' '}
          {params.modelo}
        </h3>

        <div className={styles.proveedores_bread}>
          <div>
            <Link href="/">
              <a>INICIO</a>
            </Link>
            <ChevronRight />
            {/* {logo} */}
            <a href="#">
              <img src={brandLogo(params.marca)} alt="" />
            </a>
            <ChevronRight />
            <a href="#">
              {params.marca} {params.modelo}
            </a>
            <ChevronRight />
            <a href="#">Listado de tiendas</a>
          </div>
        </div>

        {cats.map((cat, i) => (
          <div
            key={`categoria-${cat.categoriaId}`}
            className={styles.proveedores_categoria}
          >
            <div className={styles.proveedores_categoriainfo}>
              {/* START TITULO EN DESKTOP */}
              <div>
                <h3>{cat.titulo}</h3>
                <p>para {params.modelo}</p>
              </div>
              {/* END TITULO EN DESKTOP */}

              <img alt="" src={cat.imagenPrincipal.url} />
            </div>
            <div className={styles.proveedores_categoriaslider}>
              {/* START TITULO EN MOBILE */}
              <div>
                <h3>{cat.titulo}</h3>
                <p>para {params.modelo}</p>
              </div>
              {/* END TITULO EN MOBILE */}

              <div className={styles.slider_mobile}>
                {cat.tienda.map((tienda, i) => (
                  <div
                    key={`proveedores-${tienda.tiendaId}`}
                    className={styles.proveedores_slideritem}
                  >
                    <img
                      src={
                        tienda.imagenPrincipal.id
                          ? tienda.imagenPrincipal.url
                          : '/images/tienda.jpg'
                      }
                      alt=""
                    />
                    <div>
                      <button
                        onClick={() => handleDetailStore(tienda.slug)}
                        className="btn"
                      >
                        <Store />
                        <span>Ver tienda</span>
                      </button>
                    </div>
                  </div>
                ))}
              </div>

              <div className={styles.slider_desktop}>
                <Swiper
                  spaceBetween={20}
                  slidesPerView={
                    cat.tienda.length >= 5 ? nroSlides : cat.tienda.length
                  }
                  navigation
                >
                  {cat.tienda.map((tienda, i) => (
                    <SwiperSlide key={`proveedores-${tienda.tiendaId}`}>
                      <div className={styles.proveedores_slideritem}>
                        <img
                          src={
                            tienda.imagenPrincipal.id
                              ? tienda.imagenPrincipal.url
                              : '/images/tienda.jpg'
                          }
                          alt=""
                        />
                        <div>
                          <button
                            onClick={() => handleDetailStore(tienda.slug)}
                            className="btn"
                          >
                            <Store />
                            <span>Ver tienda</span>
                          </button>
                        </div>
                      </div>
                    </SwiperSlide>
                  ))}
                </Swiper>
              </div>

              <button
                onClick={() => {
                  router.push({
                    pathname: `/tienda/${cat.categoriaId}`,
                    query: {
                      marca: params.marca,
                      modelo: params.modelo,
                      motor: params.motor
                    }
                  })
                }}
                className="btn btn-secundary"
              >
                Ver mas
              </button>
            </div>
          </div>
        ))}

        {cats.length !== 0 ? renderMoreButton() : <Empty />}
      </div>
    </div>
  )
}

export default Proveedores
